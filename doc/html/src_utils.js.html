<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: src/utils.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: src/utils.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* MIT License
 *
 * Copyright (c) 2019 Andreas Merkle &lt;web@blue-andi.de>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

/**
 * NIU cloud connector utilities
 * @namespace
 */
var niuCloudConnectorUtils = {};

module.exports = niuCloudConnectorUtils;

/**
 * Convert a value in degree to radian.
 * 
 * @private
 * 
 * @param {number} n    - Value in degree.
 * 
 * @returns {number} Value in radians.
 */
function radians(n) {
    return n * (Math.PI / 180);
}

/**
 * Convert a value in radian to degree.
 * 
 * @private
 * 
 * @param {number} n    - Value in radian.
 * 
 * @returns {number} Value in degree.
 */
function degrees(n) {
    return n * (180 / Math.PI);
}

/**
 * Calculate bearing from two GPS points.
 * 
 * @private
 * 
 * @param {number} startLat     - Start latitude in decimal degree.
 * @param {number} startLong    - Start longitude in decimal degree.
 * @param {number} endLat       - End latitude in decimal degree.
 * @param {number} endLong      - End longitude in decimal degree.
 * 
 * @returns {number} Bearing [0; 360[ degree.
 */
function getBearing(startLat, startLong, endLat, endLong) {
    startLat    = radians(startLat);
    startLong   = radians(startLong);
    endLat      = radians(endLat);
    endLong     = radians(endLong);

    var dLong = endLong - startLong;

    var dPhi = Math.log(Math.tan(endLat/2.0+Math.PI/4.0)/Math.tan(startLat/2.0+Math.PI/4.0));

    if (Math.abs(dLong) > Math.PI) {
        if (dLong > 0.0) {
            dLong = -(2.0 * Math.PI - dLong);
        } else {
            dLong = (2.0 * Math.PI + dLong);
        }
    }

    return (degrees(Math.atan2(dLong, dPhi)) + 360.0) % 360.0;
}

/**
 * Convert track items to KML format.
 * 
 * @param {Object}      options             - Options.
 * @param {Object[]}    options.trackItems  - Track items.
 * 
 * @returns {string} KML data.
 */
niuCloudConnectorUtils.trackItems2Kml = function(options) {
    var funcName    = "trackItems2Kml()";
    var kmlData     = "";
    var index       = 0;
    var track       = {};
    var trackNext   = {};
    var epoch       = 0;
    var dateStr     = "";
    var lineEnding  = "\r\n";
    var bearing     = 0;
    var urlStyle    = "";

    if ("object" !== typeof options) {
        return Promise.reject(this._error("Options is missing.", funcName));
    }

    if ("object" !== typeof options.trackItems) {
        return Promise.reject(this._error("Track items is missing.", funcName));
    }

    /* KML header */
    kmlData  = "&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?>" + lineEnding;
    /* KML namespace declaration */
    kmlData += "&lt;kml xmlns=\"http://www.opengis.net/kml/2.2\">" + lineEnding;
    /* KML document */
    kmlData += "    &lt;Document>" + lineEnding;
    /* Style */
    kmlData += "    &lt;Style id=\"normalPlacemark\">" + lineEnding;
    kmlData += "        &lt;IconStyle>" + lineEnding;
    kmlData += "            &lt;Icon>" + lineEnding;
    kmlData += "                &lt;href>http://earth.google.com/images/kml-icons/track-directional/track-none.png&lt;/href>" + lineEnding;
    kmlData += "            &lt;/Icon>" + lineEnding;
    kmlData += "        &lt;/IconStyle>" + lineEnding;
    kmlData += "    &lt;/Style>" + lineEnding;

    for(index = 0; index &lt; 16; ++index) {
        kmlData += "    &lt;Style id=\"bearing" + index + "\">" + lineEnding;
        kmlData += "        &lt;IconStyle>" + lineEnding;
        kmlData += "            &lt;Icon>" + lineEnding;
        kmlData += "                &lt;href>http://earth.google.com/images/kml-icons/track-directional/track-" + index + ".png&lt;/href>" + lineEnding;
        kmlData += "            &lt;/Icon>" + lineEnding;
        kmlData += "        &lt;/IconStyle>" + lineEnding;
        kmlData += "    &lt;/Style>" + lineEnding;            
    }

    /* Covert each track item to a placement object. */
    for(index = 0; index &lt; options.trackItems.length; ++index) {

        /* Index 0 in the track items contains the destination, therefore start from the tail. */
        track = options.trackItems[options.trackItems.length - index - 1];

        if (options.trackItems.length > (index + 1)) {
            trackNext = options.trackItems[options.trackItems.length - index - 2];
        } else {
            trackNext = null;
        }

        epoch = parseInt(track.date);

        if (true === isNaN(epoch)) {
            dateStr = "-";
        } else {
            dateStr = new Date(epoch).toLocaleString();
        }

        if (null == trackNext) {
            urlStyle ="#normalPlacemark";
        } else {
            bearing = getBearing(track.lat, track.lng, trackNext.lat, trackNext.lng);

            urlStyle = "#bearing" + (Math.ceil(bearing / 22.5) % 16);
        }
        
        kmlData += "        &lt;Placemark>" + lineEnding;
        kmlData += "            &lt;name>#" + index + "&lt;/name>" + lineEnding;
        kmlData += "            &lt;description>" + dateStr + " - bearing: " + bearing + "&lt;/description>" + lineEnding;
        kmlData += "            &lt;Point>" + lineEnding;
        kmlData += "                &lt;coordinates>" + track.lng + "," + track.lat + "&lt;/coordinates>" + lineEnding;
        kmlData += "            &lt;/Point>" + lineEnding;
        kmlData += "            &lt;styleUrl>" + urlStyle + "&lt;/styleUrl>" + lineEnding;
        kmlData += "        &lt;/Placemark>" + lineEnding;
    }

    kmlData += "    &lt;/Document>" + lineEnding;
    kmlData += "&lt;/kml>";

    return kmlData;
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="niuCloudConnector.html">niuCloudConnector</a></li><li><a href="niuCloudConnectorUtils.html">niuCloudConnectorUtils</a></li></ul><h3>Classes</h3><ul><li><a href="niuCloudConnector.Client.html">Client</a></li></ul><h3>Global</h3><ul><li><a href="global.html#request">request</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.1</a> on Wed May 15 2019 21:35:35 GMT+0200 (Mitteleurop√§ische Sommerzeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
